local Players = game:GetService("Players")
local player  = Players.LocalPlayer
local char    = player.Character or player.CharacterAdded:Wait()

-- stats container
local pv = char:WaitForChild("pv")
local bd = pv:WaitForChild("bd")
local hp = pv:WaitForChild("hp")

-- reset bleed-down and grab Humanoid
bd.Value = 250
local humanoid = char:WaitForChild("Humanoid")
local origHipHeight = humanoid.HipHeight

-- GUI setup
local screenGui = Instance.new("ScreenGui", player:WaitForChild("PlayerGui"))
screenGui.ResetOnSpawn = false

local staminaBar = Instance.new("Frame", screenGui)
staminaBar.Size       = UDim2.new(0,200,0,20)
staminaBar.Position   = UDim2.new(0.5,-100,0.7,0)
staminaBar.BackgroundColor3 = Color3.new(0,0,0)
staminaBar.Visible    = false

local fillBar = Instance.new("Frame", staminaBar)
fillBar.Size             = UDim2.new(0,0,1,0)
fillBar.BackgroundColor3 = Color3.new(0,1,0)

-- helper to see if any other player is within 10 studs
local function helperIsNear()
    local root = char:FindFirstChild("HumanoidRootPart")
    if not root then return false end
    for _, other in ipairs(Players:GetPlayers()) do
        if other~=player and other.Character then
            local oroot = other.Character:FindFirstChild("HumanoidRootPart")
            if oroot and (root.Position - oroot.Position).Magnitude <= 10 then
                return true
            end
        end
    end
    return false
end

-- drain bd and force low HipHeight
local function drainBD()
    humanoid.HipHeight = 0.2
    while hp.Value == 0 and bd.Value > 0 do
        bd.Value = bd.Value - 1
        wait(0.1)
    end
    if hp.Value == 0 then
        bd.Value = -100
    end
end

-- fill the revive bar only when someoneâ€™s near
local function fillStamina()
    local fill = 0
    local barVisible = false

    while hp.Value == 0 do
        if helperIsNear() then
            if not barVisible then
                staminaBar.Visible = true
                barVisible = true
            end

            fill = fill + 1
            fillBar.Size = UDim2.new(fill/50, 0, 1, 0)

            if fill >= 50 then
                -- revive!
                hp.Value = 35
                humanoid.HipHeight = origHipHeight
                staminaBar.Visible = false
                return
            end
        else
            if barVisible then
                staminaBar.Visible = false
                barVisible = false
            end
            fill = 0
            fillBar.Size = UDim2.new(0, 0, 1, 0)
        end
        wait(0.1)
    end

    -- clean up if hp changes out of loop
    staminaBar.Visible = false
    humanoid.HipHeight = origHipHeight
end

-- hook up drain + revive when hp hits zero
hp:GetPropertyChangedSignal("Value"):Connect(function()
    if hp.Value == 0 then
        spawn(drainBD)
        spawn(fillStamina)
    end
end)
